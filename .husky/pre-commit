#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Configurar PYTHONPATH para encontrar o mÃ³dulo ebook_pipeline
export PYTHONPATH="$(pwd)/src:$PYTHONPATH"

# Executar linting
npm run lint:check

# Atualizar contagem de palavras
npm run wordcount

# Verificar se capÃ­tulos foram modificados (excluindo .claude/)
CHAPTER_CHANGES=$(git diff --cached --name-only | grep -v "^\.claude/" | grep "chapters/.*\.md" || true)

if [ -n "$CHAPTER_CHANGES" ]; then
    echo "ğŸ“š MudanÃ§as em capÃ­tulos detectadas. Verificando contexto..."
    
    # Verificar se CONTEXT.md foi atualizado
    CONTEXT_UPDATED=$(git diff --cached --name-only | grep "context/CONTEXT.md" || true)
    
    if [ -z "$CONTEXT_UPDATED" ]; then
        echo "âŒ ERRO: CapÃ­tulo modificado mas contexto nÃ£o atualizado!"
        echo "ğŸ‘‰ Execute 'make session-end' antes de fazer commit"
        exit 1
    fi
    
    # Executar verificaÃ§Ã£o de continuidade
    echo "ğŸ” Verificando continuidade..."
    python3 -m ebook_pipeline.utils.continuity_check
    
    # Verificar se hÃ¡ erros no relatÃ³rio
    if [ -f "context/continuity-report.json" ]; then
        ERROR_COUNT=$(python3 -c "import json; data=json.load(open('context/continuity-report.json')); print(data['summary']['errors'])" 2>/dev/null || echo "0")
        
        if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "âŒ ERRO: Encontrados $ERROR_COUNT erros de continuidade!"
            echo "ğŸ‘‰ Corrija os problemas e execute 'make session-end' novamente"
            python3 -c "import json; data=json.load(open('context/continuity-report.json')); [print(f\"  - {e['message']}\") for e in data['errors'][:5]]" 2>/dev/null
            exit 1
        fi
    fi
    
    echo "âœ… Todas as verificaÃ§Ãµes passaram!"
fi

# Adicionar arquivos modificados
git add chapters/*.md
git add context/*.json context/CONTEXT.md 2>/dev/null || true

# Executar quality gates
if [ -f "$(dirname "$0")/pre-commit-quality" ]; then
    echo "ğŸ” Running quality checks..."
    . "$(dirname "$0")/pre-commit-quality"
fi