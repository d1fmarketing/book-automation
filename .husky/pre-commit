#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Executar linting
npm run lint:check

# Atualizar contagem de palavras
npm run wordcount

# Verificar se capÃ­tulos foram modificados
CHAPTER_CHANGES=$(git diff --cached --name-only | grep "chapters/.*\.md" || true)

if [ -n "$CHAPTER_CHANGES" ]; then
    echo "ðŸ“š MudanÃ§as em capÃ­tulos detectadas. Verificando contexto..."
    
    # Verificar se CONTEXT.md foi atualizado
    CONTEXT_UPDATED=$(git diff --cached --name-only | grep "context/CONTEXT.md" || true)
    
    if [ -z "$CONTEXT_UPDATED" ]; then
        echo "âŒ ERRO: CapÃ­tulo modificado mas contexto nÃ£o atualizado!"
        echo "ðŸ‘‰ Execute 'make session-end' antes de fazer commit"
        exit 1
    fi
    
    # Executar verificaÃ§Ã£o de continuidade
    echo "ðŸ” Verificando continuidade..."
    python scripts/continuity-check.py
    
    # Verificar se hÃ¡ erros no relatÃ³rio
    if [ -f "context/continuity-report.json" ]; then
        ERROR_COUNT=$(python -c "import json; data=json.load(open('context/continuity-report.json')); print(data['summary']['errors'])" 2>/dev/null || echo "0")
        
        if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "âŒ ERRO: Encontrados $ERROR_COUNT erros de continuidade!"
            echo "ðŸ‘‰ Corrija os problemas e execute 'make session-end' novamente"
            python -c "import json; data=json.load(open('context/continuity-report.json')); [print(f\"  - {e['message']}\") for e in data['errors'][:5]]" 2>/dev/null
            exit 1
        fi
    fi
    
    echo "âœ… Todas as verificaÃ§Ãµes passaram!"
fi

# Adicionar arquivos modificados
git add chapters/*.md
git add context/*.json context/CONTEXT.md 2>/dev/null || true