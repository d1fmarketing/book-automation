name: Build eBook Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.9'
  PYTHONPATH: 'src'
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  IDEOGRAM_API_KEY: ${{ secrets.IDEOGRAM_API_KEY }}
  IMAGE_PROVIDER: 'ideogram'  # or 'openai'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Python dependencies
      run: |
        set -euo pipefail
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
      env:
        PYTHONPATH: src
        
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Node dependencies
      run: npm ci
      
    - name: ğŸ§ª Run Python Tests
      run: |
        set -euo pipefail
        PYTHONPATH=src pytest -v tests/
      env:
        PYTHONPATH: src
        
    - name: ğŸ“Š Analyze Chapters
      run: |
        set -euo pipefail
        echo "ğŸ“Š Analyzing all chapters..."
        python -m ebook_pipeline.context.analyzer
        echo "âœ… Chapter analysis complete!"
        
    - name: ğŸ” Check Continuity
      run: |
        set -euo pipefail
        echo "ğŸ” Running continuity checks..."
        python -m ebook_pipeline.context.continuity_checker
        echo "âœ… All continuity checks passed!"
        
    - name: ğŸ¨ Generate Images
      if: env.OPENAI_API_KEY != '' || env.IDEOGRAM_API_KEY != ''
      run: |
        set -euo pipefail
        echo "ğŸ¨ Generating AI images..."
        python -m ebook_pipeline.generators.generate_images --skip-existing
        echo "âœ… Image generation complete!"
        
    - name: ğŸ“– Build PDF
      run: |
        set -euo pipefail
        npm run build:pdf
        
    - name: ğŸ“š Build EPUB
      run: |
        set -euo pipefail
        npm run build:epub
        npm run validate:epub
        
    - name: ğŸ“ˆ Word Count Report
      run: |
        set -euo pipefail
        python -m ebook_pipeline.utils.wordcount
        
    - name: ğŸ“¦ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ebook-build-${{ github.sha }}
        path: |
          build/dist/*.pdf
          build/dist/*.epub
          context/continuity-report.json
          context/chapter-summaries.json
        retention-days: 30
        
  security-check:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ” Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“¤ Upload Security Results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'